서버의 API를 호출할 때는 총 세가지 상태를 관리해야 합니다.

우선 요청했을 때 서버가 응답할 때까지 로딩 상태를 설정해야 하며, 해당 요청이 성공했을 때와 실패했을 때 상태를 어떻게 업데이트할지 결정해야 합니다.

이런 작업은 리액트의 컴포넌트의 state만 사용해도 관리할 수 있습니다. 하지만 리덕스와 리덕스 미들웨어를 사용하여 상태를 관리한다면 작업이 훨씬 간편해집니다.

# 15.1 미들웨어 이해

# 15.1.1 미들웨어란?

리덕스 미들웨어는 액션을 디스패치했을때 리듀서에서 이를 처리하기 전에 사전에 지정된 작업들을 실행합니다. 미들웨어는 액션과 리듀서 사이의 중간자라고 볼 수 있습니다.

리두서가 액션을 처리하기 전에 미들웨어가 할 수 있는 작업은 여러 가지가 있습니다. 단순히 전달받은 액션을 콘솔에 기록할 수도 있고, 전달받은 액션 정보를 기반으로 액션을 취소해 버릴거나 다른 종류의 액션을 추가로 디스패치할 수도 있습니다.

# 15.1.2 미들웨어 생성

# 15.1.2.1 준비 작업

이 작업을 시작하기 전에 먼저 git으로 리덕스 스타터킷 프로젝트를 클론하고 npm모듈을 설치합니다.

```bash
git clone https://github.com/vlpt-playground/redux-starter-kit.git
cd redux-starter-kit
yarn
```

이 프로젝트는 create-react-app으로 만든 프로젝트에 Ducks 구조를 사용하여 리덕스를 적용한 단순한 프로젝트입니다.

간단한 숫자 카운터가 구현되어 있으며, store 생성 로직은 따로 store.js파일로 분리했습니다.

```js
// src/modules/counter.js
import {handleActions, createAction} from 'redux-actions';

const INCREMENT = 'INCREMENT';
const DECREMENT = 'DECREMENT';

export const increment = createAction(INCREMENT);
export const decrement = createAction(DECREMENT);

export default handleActions({
    [INCREMENT] : (state,action) => state + 1,
    [DECREMENT] : (state,action) => state - 1
}, 0)
```

이 카운터 모듈의 기본 값은 0이며, INCREMENT, DECREMENT 액션에 따라 숫자를 더하거나 감소시킵니다. 

```js
// src/App.js
import React , {Component} from 'react';
import { bindActionCreators } from 'redux';
import { connect } from 'react-redux';
import * as counterActions from './modules/counter';

class App extends Component {
    render(){
        const {CounterActions, number} = this.props;
        return (
            <div>
                <h1>{number}</h1>
                <button onClick={CounterActions.increment}>+</button>
                <button onClick={CounterActions.decrement}>-</button>
            </div>
        )
    }
}
export default connet(
    (state) => ({
        number : state.number
    }),
    (dispatch) => ({
        CounterActions : bindActionCreators(CounterActions, dispatch)
    })
)(App)
```

App 컴포넌트에서는 리덕스 스토어의 상태와 액션 생성 함수들을 연동했습니다.

미들웨어가 어떻게 작동하는지 이해하려면 직접 만들어 보는 것이 가장 빠릅니다.

# 15.1.2.2 로거 미들웨어 생성

src/lib 디렉토리에 loggerMiddleware.js 파일을 생성합니다.

```js
// src/lib/loggetMiddleware.js
const loggerMiddleware = store => next => action => {
    // 미들웨어 내용
}
```

next는 store.dispatch와 비슷한 역활을 합니다. 차이점은 next(action)을 했을 때는 그 다음 처리해야할 미들웨어로 액션을 넘겨주고, 추가로 처리할 미들웨어가 없다면 바로 리듀서에 넘겨준다는 것입니다.

하지만 stor.dispatch는 다음 미들웨어로 넘어가는 것이 아니라 액션을 처음부터 디스패치합니다.

따라서 미들웨어 내부에서 store.dispatch를 사용할 때는 특정 조건을 만족하면 같은 액션이 아니라 다른 액션으로 실행해야 합니다.

미들웨어를 사용해서 다음 정보들을 순서대로 기록해보겠습니다.
    1. 현재 상태
    1. 액션 상태
    1. 리듀서가 처리한 다음의 새로운 상태

```js
// src/lib/loggerMiddleware.js
const loggerMiddleware = store => next => action => {
    // 현재 스토어 상태 값 기록
    console.log('현재 상태', store.getState());
    // 액션 기록
    console.log('액션', action);

    // 액션을 다음 미들웨어 또는 리듀서로 넘깁니다.
    const result = next(action);

    // 액션 처리 후의 스토어 상태를 기록합니다.
    console.log('다음 상태', store.getState());
    console.log('\n');

    return result;
}

export default loggerMiddleware;
```

# 15.1.2.3 미들웨어 적용

미들웨어는 store를 생성할때 적용할 수 있습니다. 우리가 만든 loggerMiddleware와 Redux 모듈안에 들어 있는 미들웨어를 적용하는 함수인 applyMiddleware를 불러와 다음과 같이 코드를 입력하세요.

```js
// src/store.js
import {createStore, applyMiddleware} from 'redux';
import modules from './modules';
import loggetMiddleware from './lib/loggetMiddleware';

// 미들웨어가 여러 개일 때는 파라미터로 전달하면 됩니다. 예) applyMiddleware(a,b,c)
// 미들웨어 순서는 여기에서 전달한 파리미터 순서대로 지정합니다.
const store = createStore(modules, applyMiddleware(loggerMiddleware));

export default store;
```

이제 yarn start 명령어를 입력하여 웹 브라우저에서 페이지를 여세요. + 버튼과 - 버튼을 눌러서 미들웨어가 제대로 기록하는지 확인합니다.

미들웨어에서는 여러 가지를 할 수 있습니다. 액션 정보에 따라서 무시할 수도 있고(next를 호출하지 않고 return 하면 됩니다.), 액션 정보를 가로채서 수정한 후 리듀서로 전달할 수 도 있습니다.

미들웨어는 특히 네트워크 요청과 같은 비동기 작업을 할 때 매우 유용합니다.

# 15.1.2.4 redux-logger 라이브러리 사용

```bash
yarn add redux-logger
```

redux-logger를 설치하고 store.js 파일을 열어 다음과 같이 수정합니다. 이저에 만든 로거 미들웨어는 더이상 사용하지 않으니 삭제합니다.

```js
// src/store.js
import {createStore, applyMiddleware} from 'redux';
import modules from './modules';

import {createLogger} from 'redux-logger';

const logger = createLogger();

const store = createStore(modules, applyMiddleware(logger));

export default store;
```

